<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니티 - GameInfo</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        /* 커뮤니티 전용 스타일 */
        .community-header {
            border-bottom: 2px solid var(--divider);
            padding-bottom: 24px;
            margin-bottom: 32px;
        }

        .community-header h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .community-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* 필터 및 액션 바 */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px 0;
            border-bottom: 1px solid var(--divider);
        }

        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-group select {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--divider);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn-write {
            padding: 8px 16px;
            background: var(--accent-blue);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-write:hover {
            background: #3b82f6;
        }

        /* 게시글 목록 - 신문 스타일 */
        .posts-list {
            border-top: 1px solid var(--divider);
        }

        .post-item {
            padding: 20px 0;
            border-bottom: 1px solid var(--divider);
            transition: var(--transition);
        }

        .post-item:hover {
            background: var(--bg-hover);
            margin: 0 -16px;
            padding: 20px 16px;
        }

        .post-item.pinned {
            background: rgba(96, 165, 250, 0.05);
            border-left: 3px solid var(--accent-blue);
            padding-left: 13px;
        }

        .post-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .post-meta .category {
            padding: 2px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .post-meta .category.discussion { color: var(--accent-blue); }
        .post-meta .category.guide { color: var(--accent-green); }
        .post-meta .category.question { color: var(--accent-yellow); }
        .post-meta .category.news { color: var(--accent-red); }

        .post-meta .game-name {
            color: var(--text-secondary);
        }

        .post-meta .separator {
            color: var(--divider);
        }

        .post-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .post-title a {
            color: inherit;
        }

        .post-title a:hover {
            color: var(--accent-blue);
        }

        .post-excerpt {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .post-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .post-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 페이지네이션 */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 32px;
            padding: 24px 0;
        }

        .pagination button,
        .pagination span {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--divider);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination button:hover:not(:disabled) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .active {
            background: var(--accent-blue);
            color: var(--bg-primary);
            border-color: var(--accent-blue);
        }

        /* 로딩/에러 메시지 */
        .message {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 64px 24px;
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        /* 공지사항 팝업 */
        .announcement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .announcement-overlay.show {
            display: flex;
        }

        .announcement-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--divider);
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .announcement-header {
            padding: 20px;
            border-bottom: 1px solid var(--divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .announcement-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .announcement-header .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .announcement-header .close-btn:hover {
            color: var(--text-primary);
        }

        .announcement-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .announcement-content p {
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .announcement-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--divider);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .announcement-footer button {
            padding: 8px 16px;
            border: 1px solid var(--divider);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .announcement-footer .btn-hide-day {
            background: var(--bg-primary);
            color: var(--text-secondary);
        }

        .announcement-footer .btn-hide-day:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .announcement-footer .btn-close {
            background: var(--accent-blue);
            color: var(--bg-primary);
            border-color: var(--accent-blue);
        }

        .announcement-footer .btn-close:hover {
            background: #3b82f6;
        }
    </style>
</head>
<body>
    <!-- 공지사항 팝업 -->
    <div id="announcement-overlay" class="announcement-overlay">
        <div class="announcement-modal">
            <div class="announcement-header">
                <h3 id="announcement-title">공지사항</h3>
                <button class="close-btn" onclick="closeAnnouncement()">&times;</button>
            </div>
            <div id="announcement-content" class="announcement-content"></div>
            <div class="announcement-footer">
                <button class="btn-hide-day" onclick="hideAnnouncementForDay()">하루동안 보지 않기</button>
                <button class="btn-close" onclick="closeAnnouncement()">닫기</button>
            </div>
        </div>
    </div>

    <!-- 헤더 -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <h1 class="site-title">
                    <a href="index.html">GameInfo</a>
                </h1>
                <nav class="main-nav">
                    <ul>
                        <li><a href="index.html">홈</a></li>
                        <li><a href="calendar.html">캘린더</a></li>
                        <li><a href="games.html">게임 목록</a></li>
                        <li id="nav-community"><a href="community.html">커뮤니티</a></li>
                        <li id="nav-admin" style="display:none;"><a href="admin.html">관리자</a></li>
                        <li id="nav-profile" style="display:none;"><a href="profile.html">프로필</a></li>
                        <li id="nav-login"><a href="login.html">로그인</a></li>
                        <li id="nav-logout" style="display:none;"><a href="#" onclick="handleLogout(event)">로그아웃</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="main-content">
        <div class="container">
            <!-- 커뮤니티 헤더 -->
            <section class="community-header">
                <h2>커뮤니티</h2>
                <p>게임 정보를 공유하고 다른 유저들과 소통하세요</p>
            </section>

            <!-- 액션 바 -->
            <div class="action-bar">
                <div class="filter-group">
                    <select id="category-filter">
                        <option value="">전체 카테고리</option>
                        <option value="discussion">자유</option>
                        <option value="guide">가이드</option>
                        <option value="news">소식</option>
                        <option value="question">질문</option>
                        <option value="humor">유머</option>
                        <option value="fanart">팬아트</option>
                    </select>

                    <select id="game-filter">
                        <option value="">전체 게임</option>
                        <!-- JavaScript로 동적 로드 -->
                    </select>
                </div>

                <button class="btn-write" id="btn-write" onclick="handleWritePost()">글쓰기</button>
            </div>

            <!-- 게시글 목록 -->
            <div id="posts-container" class="posts-list">
                <div class="message">로딩 중...</div>
            </div>

            <!-- 페이지네이션 -->
            <div id="pagination-container" class="pagination" style="display: none;"></div>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 GameInfo. 대학교 과제 프로젝트</p>
            <p>모든 게임 관련 상표는 해당 소유자의 자산입니다.</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="../js/api.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        let currentPage = 1;
        let currentFilters = {};

        // 카테고리 한글 매핑
        const categoryNames = {
            'discussion': '자유',
            'guide': '가이드',
            'news': '소식',
            'question': '질문',
            'humor': '유머',
            'fanart': '팬아트'
        };

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            await loadGames();
            await loadPosts();
            await loadAnnouncements();

            // 필터 이벤트 리스너
            document.getElementById('category-filter').addEventListener('change', handleFilterChange);
            document.getElementById('game-filter').addEventListener('change', handleFilterChange);
        });

        // 게임 목록 로드
        async function loadGames() {
            try {
                const response = await API.games.getAll({ page: 1, limit: 100 });
                if (response.success && response.data) {
                    const gameFilter = document.getElementById('game-filter');
                    const games = response.data.games || [];

                    games.forEach(game => {
                        const option = document.createElement('option');
                        option.value = game.game_id;
                        option.textContent = game.game_name;
                        gameFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load games:', error);
            }
        }

        // 게시글 목록 로드
        async function loadPosts(page = 1) {
            currentPage = page;
            const postsContainer = document.getElementById('posts-container');
            const paginationContainer = document.getElementById('pagination-container');

            postsContainer.innerHTML = '<div class="message">로딩 중...</div>';
            paginationContainer.style.display = 'none';

            try {
                const params = {
                    page: page,
                    limit: 20,
                    pinned_first: true,
                    ...currentFilters
                };

                const queryString = new URLSearchParams(params).toString();
                const response = await fetch(`${API.baseURL}/posts?${queryString}`, {
                    headers: API.getHeaders()
                });

                const data = await response.json();

                if (data.success && data.data) {
                    renderPosts(data.data.posts || []);
                    renderPagination(data.data.pagination);
                } else {
                    postsContainer.innerHTML = '<div class="message">게시글을 불러올 수 없습니다.</div>';
                }
            } catch (error) {
                console.error('Failed to load posts:', error);
                postsContainer.innerHTML = '<div class="message">게시글을 불러오는 중 오류가 발생했습니다.</div>';
            }
        }

        // 게시글 렌더링
        function renderPosts(posts) {
            const postsContainer = document.getElementById('posts-container');

            if (posts.length === 0) {
                postsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>아직 게시글이 없습니다.</p>
                        <button class="btn-write" onclick="handleWritePost()">첫 게시글 작성하기</button>
                    </div>
                `;
                return;
            }

            postsContainer.innerHTML = posts.map(post => {
                const categoryName = categoryNames[post.category] || post.category;
                const excerpt = post.content.replace(/<[^>]*>/g, '').substring(0, 150);
                const createdAt = new Date(post.created_at).toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                return `
                    <div class="post-item ${post.is_pinned ? 'pinned' : ''}">
                        <div class="post-meta">
                            <span class="category ${post.category}">${categoryName}</span>
                            ${post.game_name ? `<span class="game-name">${post.game_name}</span>` : ''}
                            <span class="separator">|</span>
                            <span class="author">${post.display_name || post.username}</span>
                            <span class="separator">|</span>
                            <span class="date">${createdAt}</span>
                        </div>
                        <h3 class="post-title">
                            <a href="community_post.html?id=${post.post_id}">
                                ${post.is_pinned ? '[공지] ' : ''}${post.title}
                            </a>
                        </h3>
                        <p class="post-excerpt">${excerpt}</p>
                        <div class="post-stats">
                            <span>조회 ${post.view_count || 0}</span>
                            <span>댓글 ${post.comment_count || 0}</span>
                            <span>좋아요 ${post.like_count || 0}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 페이지네이션 렌더링
        function renderPagination(pagination) {
            const paginationContainer = document.getElementById('pagination-container');

            if (!pagination || pagination.total_pages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'flex';

            const { current_page, total_pages } = pagination;
            let html = '';

            // 이전 버튼
            html += `<button onclick="loadPosts(${current_page - 1})" ${current_page === 1 ? 'disabled' : ''}>이전</button>`;

            // 페이지 번호
            const startPage = Math.max(1, current_page - 2);
            const endPage = Math.min(total_pages, current_page + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `<span class="${i === current_page ? 'active' : ''}" onclick="loadPosts(${i})" style="cursor:pointer">${i}</span>`;
            }

            // 다음 버튼
            html += `<button onclick="loadPosts(${current_page + 1})" ${current_page === total_pages ? 'disabled' : ''}>다음</button>`;

            paginationContainer.innerHTML = html;
        }

        // 필터 변경 처리
        function handleFilterChange() {
            const category = document.getElementById('category-filter').value;
            const gameId = document.getElementById('game-filter').value;

            currentFilters = {};

            if (category) {
                currentFilters.category = category;
            }

            if (gameId) {
                currentFilters.game_id = gameId;
            }

            loadPosts(1);
        }

        // 글쓰기 버튼 클릭
        function handleWritePost() {
            if (!requireLogin()) {
                return;
            }
            window.location.href = 'community_write.html';
        }

        // 공지사항 로드
        async function loadAnnouncements() {
            // 하루동안 보지 않기 확인
            const hideUntil = localStorage.getItem('hideAnnouncementsUntil');
            if (hideUntil) {
                const hideTime = new Date(hideUntil);
                if (hideTime > new Date()) {
                    console.log('공지사항 숨김 (24시간 유지)');
                    return;
                }
                // 만료되었으면 제거
                localStorage.removeItem('hideAnnouncementsUntil');
            }

            try {
                const response = await fetch(`${API.baseURL}/announcements`, {
                    headers: API.getHeaders()
                });

                const data = await response.json();

                if (data.success && data.data && data.data.length > 0) {
                    // 가장 최근 공지사항 표시
                    showAnnouncement(data.data[0]);
                }
            } catch (error) {
                console.error('Failed to load announcements:', error);
            }
        }

        // 공지사항 표시
        function showAnnouncement(announcement) {
            const overlay = document.getElementById('announcement-overlay');
            const titleEl = document.getElementById('announcement-title');
            const contentEl = document.getElementById('announcement-content');

            titleEl.textContent = announcement.title;

            // 내용 표시 (HTML 이스케이프 처리)
            let content = announcement.content || '';
            content = content.replace(/\n/g, '<br>');
            contentEl.innerHTML = `<p>${content}</p>`;

            // 링크가 있으면 추가
            if (announcement.link_url) {
                contentEl.innerHTML += `<p><a href="${announcement.link_url}" target="_blank" style="color: var(--accent-blue);">자세히 보기</a></p>`;
            }

            overlay.classList.add('show');
        }

        // 공지사항 닫기
        function closeAnnouncement() {
            const overlay = document.getElementById('announcement-overlay');
            overlay.classList.remove('show');
        }

        // 하루동안 보지 않기
        function hideAnnouncementForDay() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            localStorage.setItem('hideAnnouncementsUntil', tomorrow.toISOString());
            closeAnnouncement();
        }

        // 오버레이 클릭 시 닫기
        document.addEventListener('DOMContentLoaded', () => {
            const overlay = document.getElementById('announcement-overlay');
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeAnnouncement();
                }
            });
        });
    </script>
</body>
</html>
