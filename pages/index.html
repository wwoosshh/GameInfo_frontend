<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="게임 업데이트 정보를 한눈에 확인하세요">
    <title>GameInfo - 게임 정보 트래커</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        /* 검색 섹션 */
        .search-section {
            margin-bottom: 48px;
        }

        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            padding-right: 50px;
            font-size: 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--divider);
            border-radius: 12px;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: var(--bg-primary);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            color: var(--text-muted);
            font-size: 20px;
            pointer-events: none;
        }

        .search-clear {
            position: absolute;
            right: 45px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            display: none;
        }

        .search-clear.show {
            display: block;
        }

        .search-clear:hover {
            color: var(--text-primary);
        }

        /* 검색 결과 */
        .search-results {
            margin-top: 32px;
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--divider);
        }

        .search-results-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .search-results-count {
            font-size: 14px;
            color: var(--text-muted);
        }

        .search-results-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* 검색 결과 카드 (버전 카드) */
        .version-card {
            background: var(--bg-secondary);
            border: 1px solid var(--divider);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .version-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .version-card-header {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }

        .version-card-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-primary);
            flex-shrink: 0;
        }

        .version-card-info {
            flex: 1;
            min-width: 0;
        }

        .version-card-game {
            font-size: 12px;
            color: var(--accent-blue);
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .version-card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .version-card-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .version-card-date {
            font-size: 13px;
            color: var(--text-muted);
        }

        .version-card-date.current {
            color: var(--accent-green);
        }

        /* 매칭된 항목들 */
        .matched-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--divider);
        }

        .matched-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-primary);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .matched-item-icon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            object-fit: cover;
        }

        .matched-item-more {
            padding: 6px 10px;
            background: rgba(96, 165, 250, 0.1);
            border-radius: 6px;
            font-size: 12px;
            color: var(--accent-blue);
        }

        /* 검색 중 로딩 */
        .search-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* 검색 결과 없음 */
        .search-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .search-empty h3 {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .search-empty p {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* 페이지네이션 */
        .search-pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }

        .search-pagination button {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--divider);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .search-pagination button:hover:not(:disabled) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .search-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 인기 게임 섹션 */
        .games-section {
            margin-top: 48px;
        }

        @media (max-width: 768px) {
            .search-input {
                padding: 14px 16px;
                font-size: 15px;
            }

            .version-card-header {
                flex-direction: column;
            }

            .version-card-thumbnail {
                width: 100%;
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <h1 class="site-title">
                    <a href="index.html">GameInfo</a>
                </h1>
                <nav class="main-nav">
                    <ul>
                        <li><a href="index.html">홈</a></li>
                        <li><a href="calendar.html">캘린더</a></li>
                        <li><a href="games.html">게임 목록</a></li>
                        <li id="nav-community"><a href="community.html">커뮤니티</a></li>
                        <li id="nav-admin" style="display:none;"><a href="admin.html">관리자</a></li>
                        <li id="nav-profile" style="display:none;"><a href="profile.html">프로필</a></li>
                        <li id="nav-login"><a href="login.html">로그인</a></li>
                        <li id="nav-logout" style="display:none;"><a href="#" onclick="handleLogout(event)">로그아웃</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="main-content">
        <div class="container">
            <!-- 환영 섹션 -->
            <section class="welcome-section">
                <h2>게임 버전 검색</h2>
                <p>게임, 버전, 캐릭터, 아이템 등을 검색해보세요</p>
            </section>

            <!-- 검색 섹션 -->
            <section class="search-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input
                            type="text"
                            id="search-input"
                            class="search-input"
                            placeholder="검색어를 입력하세요... (게임, 버전, 캐릭터, 아이템)"
                            autocomplete="off"
                        >
                        <button id="search-clear" class="search-clear">&times;</button>
                        <span class="search-icon">&#128269;</span>
                    </div>
                </div>

                <!-- 검색 결과 -->
                <div id="search-results" class="search-results">
                    <div class="search-results-header">
                        <span class="search-results-title">검색 결과</span>
                        <span id="search-results-count" class="search-results-count"></span>
                    </div>
                    <div id="search-results-list" class="search-results-list">
                        <!-- 검색 결과가 여기에 표시됩니다 -->
                    </div>
                    <div id="search-pagination" class="search-pagination"></div>
                </div>
            </section>

            <!-- 게임 목록 -->
            <section class="games-section">
                <div class="section-header">
                    <h3>인기 게임</h3>
                    <a href="games.html" class="view-all">전체 보기 &rarr;</a>
                </div>

                <div id="games-list" class="games-grid">
                    <!-- JavaScript로 동적 로드 -->
                    <div class="loading">로딩 중...</div>
                </div>
            </section>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 GameInfo. 대학교 과제 프로젝트</p>
            <p>모든 게임 관련 상표는 해당 소유자의 자산입니다.</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="../js/api.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        // 검색 관련 변수
        let searchTimeout = null;
        let currentSearchQuery = '';
        let currentSearchPage = 1;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            loadGames();
            initSearch();
        });

        // 검색 초기화
        function initSearch() {
            const searchInput = document.getElementById('search-input');
            const searchClear = document.getElementById('search-clear');

            // 입력 이벤트 (디바운싱 적용)
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                // 클리어 버튼 표시/숨김
                searchClear.classList.toggle('show', query.length > 0);

                // 디바운싱: 300ms 후에 검색 실행
                clearTimeout(searchTimeout);

                if (query.length === 0) {
                    hideSearchResults();
                    return;
                }

                searchTimeout = setTimeout(() => {
                    performSearch(query, 1);
                }, 300);
            });

            // Enter 키로 즉시 검색
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    if (query.length > 0) {
                        performSearch(query, 1);
                    }
                }
            });

            // 클리어 버튼
            searchClear.addEventListener('click', () => {
                searchInput.value = '';
                searchClear.classList.remove('show');
                hideSearchResults();
                searchInput.focus();
            });
        }

        // 검색 실행
        async function performSearch(query, page = 1) {
            currentSearchQuery = query;
            currentSearchPage = page;

            const resultsContainer = document.getElementById('search-results');
            const resultsList = document.getElementById('search-results-list');
            const resultsCount = document.getElementById('search-results-count');

            // 검색 결과 영역 표시
            resultsContainer.classList.add('show');
            resultsList.innerHTML = '<div class="search-loading">검색 중...</div>';

            try {
                const response = await API.search.query(query, { page, limit: 10 });

                if (response.success) {
                    const { versions, pagination } = response.data;

                    resultsCount.textContent = `${pagination.total_items}개의 버전`;

                    if (versions.length === 0) {
                        resultsList.innerHTML = `
                            <div class="search-empty">
                                <h3>"${escapeHtml(query)}"에 대한 검색 결과가 없습니다</h3>
                                <p>다른 검색어로 시도해보세요</p>
                            </div>
                        `;
                        document.getElementById('search-pagination').innerHTML = '';
                        return;
                    }

                    // 검색 결과 표시
                    resultsList.innerHTML = versions.map(version => createVersionCard(version)).join('');

                    // 페이지네이션
                    displaySearchPagination(pagination);
                } else {
                    resultsList.innerHTML = '<div class="search-empty"><h3>검색 중 오류가 발생했습니다</h3></div>';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsList.innerHTML = '<div class="search-empty"><h3>검색 중 오류가 발생했습니다</h3></div>';
            }
        }

        // 버전 카드 생성
        function createVersionCard(version) {
            const thumbnail = version.thumbnail_url || version.banner_image_url || version.game_thumbnail_url || '';
            const releaseDate = version.release_date ? formatDate(version.release_date) : '날짜 미정';
            const isCurrentBadge = version.is_current ? '<span class="version-card-date current">현재 버전</span>' : '';

            // 매칭된 항목들
            let matchedItemsHtml = '';
            if (version.matched_items && version.matched_items.length > 0) {
                const items = version.matched_items.map(item => `
                    <div class="matched-item">
                        ${item.icon_url ? `<img src="${item.icon_url}" class="matched-item-icon" alt="">` : ''}
                        <span>${escapeHtml(item.item_name)}</span>
                    </div>
                `).join('');

                const moreCount = version.matched_items_count - version.matched_items.length;
                const moreHtml = moreCount > 0 ? `<div class="matched-item-more">+${moreCount}개 더</div>` : '';

                matchedItemsHtml = `
                    <div class="matched-items">
                        ${items}
                        ${moreHtml}
                    </div>
                `;
            }

            return `
                <div class="version-card" onclick="goToVersion(${version.version_id})">
                    <div class="version-card-header">
                        ${thumbnail ? `<img src="${thumbnail}" class="version-card-thumbnail" alt="">` : '<div class="version-card-thumbnail"></div>'}
                        <div class="version-card-info">
                            <div class="version-card-game">${escapeHtml(version.game_name)}</div>
                            <div class="version-card-title">버전 ${escapeHtml(version.version_number)}</div>
                            ${version.version_name ? `<div class="version-card-subtitle">${escapeHtml(version.version_name)}</div>` : ''}
                            <div class="version-card-date">${releaseDate} ${isCurrentBadge}</div>
                        </div>
                    </div>
                    ${matchedItemsHtml}
                </div>
            `;
        }

        // 검색 페이지네이션
        function displaySearchPagination(pagination) {
            const paginationEl = document.getElementById('search-pagination');
            const { current_page, total_pages } = pagination;

            if (total_pages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            paginationEl.innerHTML = `
                <button onclick="performSearch('${escapeHtml(currentSearchQuery)}', ${current_page - 1})" ${current_page === 1 ? 'disabled' : ''}>이전</button>
                <span style="padding: 8px 12px; color: var(--text-muted);">페이지 ${current_page} / ${total_pages}</span>
                <button onclick="performSearch('${escapeHtml(currentSearchQuery)}', ${current_page + 1})" ${current_page === total_pages ? 'disabled' : ''}>다음</button>
            `;
        }

        // 검색 결과 숨기기
        function hideSearchResults() {
            document.getElementById('search-results').classList.remove('show');
        }

        // 버전 상세 페이지로 이동
        function goToVersion(versionId) {
            window.location.href = `version_detail.html?version_id=${versionId}`;
        }

        // 게임 목록 로드
        async function loadGames() {
            const gamesList = document.getElementById('games-list');

            try {
                const response = await API.games.getAll({ limit: 6 });

                if (response.success && response.data.games) {
                    displayGames(response.data.games);
                } else {
                    gamesList.innerHTML = '<div class="empty-state"><p>게임 목록을 불러올 수 없습니다.</p></div>';
                }
            } catch (error) {
                console.error('Failed to load games:', error);
                gamesList.innerHTML = '<div class="empty-state"><p>게임 목록을 불러오는데 실패했습니다.</p></div>';
            }
        }

        // 게임 목록 표시
        function displayGames(games) {
            const gamesList = document.getElementById('games-list');

            if (games.length === 0) {
                gamesList.innerHTML = '<div class="empty-state"><p>등록된 게임이 없습니다.</p></div>';
                return;
            }

            gamesList.innerHTML = games.map(game => `
                <div class="game-card" onclick="window.location.href='game_versions.html?game_id=${game.game_id}'">
                    ${game.thumbnail_url
                        ? `<img src="${game.thumbnail_url}" alt="${escapeHtml(game.game_name)}" class="game-thumbnail">`
                        : '<div class="game-thumbnail-placeholder">No Image</div>'
                    }
                    <div class="game-info">
                        <h4 class="game-name">${escapeHtml(game.game_name)}</h4>
                        ${game.developer ? `<p class="game-developer">${escapeHtml(game.developer)}</p>` : ''}
                        ${game.genre ? `<span class="game-genre">${escapeHtml(game.genre)}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // 날짜 포맷
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
