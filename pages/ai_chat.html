<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì±„íŒ… - GameInfo</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        /* ë ˆì´ì•„ì›ƒ */
        .chat-container {
            display: flex;
            height: calc(100vh - 140px);
            max-width: 1400px;
            margin: 0 auto;
            gap: 0;
        }

        /* ì‚¬ì´ë“œë°” - ëŒ€í™”ë°© ëª©ë¡ */
        .chat-sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--divider);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--divider);
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
        }

        .new-chat-btn:hover {
            background: #3b82f6;
        }

        .chat-rooms-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-room-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-room-item:hover {
            background: var(--bg-hover);
        }

        .chat-room-item.active {
            background: var(--bg-hover);
            border: 1px solid var(--accent-blue);
        }

        .chat-room-icon {
            font-size: 18px;
        }

        .chat-room-info {
            flex: 1;
            min-width: 0;
        }

        .chat-room-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-room-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .chat-room-delete {
            opacity: 0;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            transition: var(--transition);
        }

        .chat-room-item:hover .chat-room-delete {
            opacity: 1;
        }

        .chat-room-delete:hover {
            color: var(--accent-red);
        }

        /* ë©”ì¸ ì±„íŒ… ì˜ì—­ */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* ì±„íŒ… í—¤ë” */
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--divider);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .model-selector {
            padding: 6px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--divider);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .settings-btn {
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--divider);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .settings-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* ë©”ì‹œì§€ ì˜ì—­ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 16px;
            max-width: 900px;
        }

        .message.user {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .message.user .message-avatar {
            background: var(--accent-blue);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .message.assistant .message-bubble {
            background: var(--bg-secondary);
            border: 1px solid var(--divider);
            color: var(--text-primary);
        }

        .message.user .message-bubble {
            background: var(--accent-blue);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .message.user .message-time {
            text-align: right;
        }

        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        /* ì…ë ¥ ì˜ì—­ */
        .chat-input-container {
            padding: 16px 24px;
            border-top: 1px solid var(--divider);
            background: var(--bg-secondary);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            max-width: 900px;
            margin: 0 auto;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            background: var(--bg-primary);
            border: 1px solid var(--divider);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 24px;
            max-height: 200px;
            line-height: 1.5;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            padding: 14px 20px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .send-btn:hover:not(:disabled) {
            background: #3b82f6;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ollama ë¯¸ì—°ê²° ìƒíƒœ */
        .ollama-not-connected {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
            text-align: center;
        }

        .ollama-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .ollama-not-connected h2 {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .ollama-not-connected p {
            color: var(--text-secondary);
            margin-bottom: 24px;
            max-width: 500px;
            line-height: 1.6;
        }

        .ollama-steps {
            text-align: left;
            background: var(--bg-secondary);
            border: 1px solid var(--divider);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            max-width: 500px;
        }

        .ollama-steps h3 {
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .ollama-steps ol {
            margin: 0;
            padding-left: 20px;
            color: var(--text-secondary);
        }

        .ollama-steps li {
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .ollama-steps code {
            background: var(--bg-primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--accent-blue);
        }

        .ollama-steps a {
            color: var(--accent-blue);
        }

        .retry-btn {
            padding: 12px 24px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .retry-btn:hover {
            background: #3b82f6;
        }

        .download-bat-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .download-bat-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .download-bat-btn::before {
            content: 'â¬‡ï¸';
        }

        /* ì„¤ì • ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--divider);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-content {
            padding: 20px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--divider);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input[type="range"] {
            padding: 0;
        }

        .range-value {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--divider);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-footer button {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-cancel {
            background: var(--bg-primary);
            border: 1px solid var(--divider);
            color: var(--text-secondary);
        }

        .btn-save {
            background: var(--accent-blue);
            border: none;
            color: white;
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: 48px;
        }

        .empty-chat-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-chat h3 {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        .sidebar-toggle {
            display: none;
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .chat-sidebar {
                position: fixed;
                left: -280px;
                top: 60px;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s ease;
            }

            .chat-sidebar.show {
                left: 0;
            }

            .sidebar-toggle {
                display: block;
            }

            .chat-messages {
                padding: 16px;
            }

            .message {
                gap: 10px;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <h1 class="site-title">
                    <a href="index.html">GameInfo</a>
                </h1>
                <nav class="main-nav">
                    <ul>
                        <li><a href="index.html">í™ˆ</a></li>
                        <li><a href="calendar.html">ìº˜ë¦°ë”</a></li>
                        <li><a href="games.html">ê²Œì„ ëª©ë¡</a></li>
                        <li id="nav-community"><a href="community.html">ì»¤ë®¤ë‹ˆí‹°</a></li>
                        <li><a href="ai_chat.html" class="active">AI ì±„íŒ…</a></li>
                        <li id="nav-admin" style="display:none;"><a href="admin.html">ê´€ë¦¬ì</a></li>
                        <li id="nav-profile" style="display:none;"><a href="profile.html">í”„ë¡œí•„</a></li>
                        <li id="nav-login"><a href="login.html">ë¡œê·¸ì¸</a></li>
                        <li id="nav-logout" style="display:none;"><a href="#" onclick="handleLogout(event)">ë¡œê·¸ì•„ì›ƒ</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>AI ì„¤ì •</h3>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label for="setting-model">ê¸°ë³¸ ëª¨ë¸</label>
                    <select id="setting-model"></select>
                </div>
                <div class="form-group">
                    <label for="setting-temperature">Temperature (ì°½ì˜ì„±)</label>
                    <input type="range" id="setting-temperature" min="0" max="2" step="0.1" value="0.7">
                    <div class="range-value">í˜„ì¬ ê°’: <span id="temp-value">0.7</span></div>
                </div>
                <div class="form-group">
                    <label for="setting-system-prompt">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
                    <textarea id="setting-system-prompt" placeholder="AIì˜ ì—­í• ì„ ì •ì˜í•©ë‹ˆë‹¤..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeSettingsModal()">ì·¨ì†Œ</button>
                <button class="btn-save" onclick="saveSettings()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content" style="padding: 0; max-width: none;">
        <!-- Ollama ë¯¸ì—°ê²° ìƒíƒœ -->
        <div id="ollama-not-connected" class="ollama-not-connected" style="display: none;">
            <div class="ollama-icon">ğŸ¦™</div>
            <h2>Ollamaì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
            <p>AI ì±„íŒ…ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œì»¬ì— Ollamaê°€ ì„¤ì¹˜ë˜ê³  ì›¹ ì ‘ê·¼ì´ í—ˆìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</p>

            <div class="ollama-steps">
                <h3>ê°„ë‹¨ ì„¤ì • (Windows)</h3>
                <ol>
                    <li>Ollamaê°€ ì—†ë‹¤ë©´ <a href="https://ollama.com/download" target="_blank">ì—¬ê¸°ì„œ ì„¤ì¹˜</a></li>
                    <li>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹¤í–‰ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</li>
                    <li>ë‹¤ìš´ë¡œë“œëœ <strong>ollama_start.bat</strong> íŒŒì¼ì„ ë”ë¸”í´ë¦­í•˜ì—¬ ì‹¤í–‰</li>
                    <li>"ë‹¤ì‹œ ì—°ê²° ì‹œë„" ë²„íŠ¼ í´ë¦­</li>
                </ol>
                <button class="download-bat-btn" onclick="downloadOllamaBat()">
                    ollama_start.bat ë‹¤ìš´ë¡œë“œ
                </button>

                <details style="margin-top: 20px; text-align: left;">
                    <summary style="cursor: pointer; color: var(--text-muted);">Mac/Linux ì‚¬ìš©ì ë˜ëŠ” ìˆ˜ë™ ì„¤ì •</summary>
                    <div style="margin-top: 12px; padding: 12px; background: var(--bg-primary); border-radius: 8px;">
                        <p style="margin-bottom: 8px;"><strong>Mac/Linux:</strong></p>
                        <code style="display: block; margin-bottom: 12px;">OLLAMA_ORIGINS=* ollama serve</code>
                        <p style="margin-bottom: 8px;"><strong>ëª¨ë¸ ë‹¤ìš´ë¡œë“œ:</strong></p>
                        <code>ollama pull llama3.2</code>
                    </div>
                </details>
            </div>

            <button class="retry-btn" onclick="checkOllamaConnection()">ë‹¤ì‹œ ì—°ê²° ì‹œë„</button>
        </div>

        <!-- ì±„íŒ… ì»¨í…Œì´ë„ˆ -->
        <div id="chat-container" class="chat-container" style="display: none;">
            <!-- ì‚¬ì´ë“œë°” -->
            <aside class="chat-sidebar" id="chat-sidebar">
                <div class="sidebar-header">
                    <button class="new-chat-btn" onclick="createNewChat()">
                        <span>+</span> ìƒˆ ëŒ€í™”
                    </button>
                </div>
                <div class="chat-rooms-list" id="chat-rooms-list">
                    <!-- ëŒ€í™”ë°© ëª©ë¡ -->
                </div>
            </aside>

            <!-- ë©”ì¸ ì±„íŒ… -->
            <div class="chat-main">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
                        <span class="chat-header-title" id="chat-title">ìƒˆ ëŒ€í™”</span>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <select class="model-selector" id="model-selector" onchange="changeModel()">
                            <!-- ëª¨ë¸ ëª©ë¡ -->
                        </select>
                        <button class="settings-btn" onclick="openSettingsModal()">âš™ï¸ ì„¤ì •</button>
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="empty-chat">
                        <div class="empty-chat-icon">ğŸ’¬</div>
                        <h3>ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”</h3>
                        <p>AIì—ê²Œ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”</p>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea
                            class="chat-input"
                            id="chat-input"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            rows="1"
                            onkeydown="handleInputKeydown(event)"
                            oninput="autoResizeTextarea(this)"
                        ></textarea>
                        <button class="send-btn" id="send-btn" onclick="sendMessage()">
                            ì „ì†¡
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        // Ollama ì„¤ì •
        const OLLAMA_BASE_URL = 'http://localhost:11434';

        // ìƒíƒœ ë³€ìˆ˜
        let isConnected = false;
        let currentRoomId = null;
        let chatRooms = [];
        let isGenerating = false;
        let currentModel = 'llama3.2';
        let settings = {
            defaultModel: 'llama3.2',
            temperature: 0.7,
            systemPrompt: 'ë‹¹ì‹ ì€ ì¹œì ˆí•˜ê³  ë„ì›€ì´ ë˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ëŒ€í™”í•´ì£¼ì„¸ìš”.'
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadChatRooms();
            checkOllamaConnection();
        });

        // ë°°ì¹˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadOllamaBat() {
            const batContent = `@echo off
echo ========================================
echo   Ollama Web Access Mode
echo ========================================
echo.

echo Stopping existing Ollama process...
taskkill /f /im ollama.exe >nul 2>&1
taskkill /f /im "ollama app.exe" >nul 2>&1
timeout /t 3 /nobreak >nul

echo Setting CORS environment variable...
set OLLAMA_ORIGINS=*

where ollama >nul 2>&1
if %errorlevel% neq 0 (
    echo.
    echo [ERROR] Ollama is not installed.
    echo Please install from https://ollama.com/download
    echo.
    pause
    exit /b 1
)

echo.
echo Installed models:
ollama list
echo.

echo ========================================
echo Starting Ollama server...
echo DO NOT CLOSE THIS WINDOW!
echo.
echo Click "Retry Connection" button in browser.
echo ========================================
echo.

ollama serve
`;

            const blob = new Blob([batContent], { type: 'text/plain;charset=ascii' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ollama_start.bat';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function checkOllamaConnection() {
            try {
                const response = await fetch(`${OLLAMA_BASE_URL}/api/tags`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    isConnected = true;
                    showChatInterface();
                    populateModelSelector(data.models || []);
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                console.error('Ollama connection error:', error);
                isConnected = false;
                showNotConnected();
            }
        }

        // ì—°ê²° ì•ˆë¨ í™”ë©´ í‘œì‹œ
        function showNotConnected() {
            document.getElementById('ollama-not-connected').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'none';
        }

        // ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
        function showChatInterface() {
            document.getElementById('ollama-not-connected').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';

            // ë§ˆì§€ë§‰ ëŒ€í™”ë°© ë˜ëŠ” ìƒˆ ëŒ€í™” ì‹œì‘
            if (chatRooms.length > 0) {
                selectRoom(chatRooms[0].id);
            }
        }

        // ëª¨ë¸ ì„ íƒê¸° ì±„ìš°ê¸°
        function populateModelSelector(models) {
            const selector = document.getElementById('model-selector');
            const settingModel = document.getElementById('setting-model');

            if (models.length === 0) {
                selector.innerHTML = '<option value="">ëª¨ë¸ ì—†ìŒ</option>';
                settingModel.innerHTML = '<option value="">ëª¨ë¸ ì—†ìŒ</option>';
                return;
            }

            const options = models.map(m =>
                `<option value="${m.name}" ${m.name === currentModel ? 'selected' : ''}>${m.name}</option>`
            ).join('');

            selector.innerHTML = options;
            settingModel.innerHTML = options;

            // ì €ì¥ëœ ëª¨ë¸ì´ ìˆìœ¼ë©´ ì„ íƒ
            if (settings.defaultModel) {
                selector.value = settings.defaultModel;
                settingModel.value = settings.defaultModel;
                currentModel = settings.defaultModel;
            } else if (models.length > 0) {
                currentModel = models[0].name;
            }
        }

        // ëª¨ë¸ ë³€ê²½
        function changeModel() {
            currentModel = document.getElementById('model-selector').value;
        }

        // ëŒ€í™”ë°© ê´€ë¦¬
        function loadChatRooms() {
            const saved = localStorage.getItem('ai_chat_rooms');
            chatRooms = saved ? JSON.parse(saved) : [];
            renderChatRooms();
        }

        function saveChatRooms() {
            localStorage.setItem('ai_chat_rooms', JSON.stringify(chatRooms));
        }

        function renderChatRooms() {
            const list = document.getElementById('chat-rooms-list');

            if (chatRooms.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            list.innerHTML = chatRooms.map(room => `
                <div class="chat-room-item ${room.id === currentRoomId ? 'active' : ''}" onclick="selectRoom('${room.id}')">
                    <span class="chat-room-icon">ğŸ’¬</span>
                    <div class="chat-room-info">
                        <div class="chat-room-title">${escapeHtml(room.title)}</div>
                        <div class="chat-room-date">${formatDate(room.updatedAt)}</div>
                    </div>
                    <button class="chat-room-delete" onclick="event.stopPropagation(); deleteRoom('${room.id}')">&times;</button>
                </div>
            `).join('');
        }

        function createNewChat() {
            const room = {
                id: 'room_' + Date.now(),
                title: 'ìƒˆ ëŒ€í™”',
                model: currentModel,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            chatRooms.unshift(room);
            saveChatRooms();
            selectRoom(room.id);
            renderChatRooms();
        }

        function selectRoom(roomId) {
            currentRoomId = roomId;
            const room = chatRooms.find(r => r.id === roomId);

            if (room) {
                document.getElementById('chat-title').textContent = room.title;
                if (room.model) {
                    currentModel = room.model;
                    document.getElementById('model-selector').value = room.model;
                }
            }

            loadMessages();
            renderChatRooms();
        }

        function deleteRoom(roomId) {
            if (!confirm('ì´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            chatRooms = chatRooms.filter(r => r.id !== roomId);
            localStorage.removeItem(`ai_chat_messages_${roomId}`);
            saveChatRooms();

            if (currentRoomId === roomId) {
                currentRoomId = null;
                if (chatRooms.length > 0) {
                    selectRoom(chatRooms[0].id);
                } else {
                    document.getElementById('chat-messages').innerHTML = `
                        <div class="empty-chat">
                            <div class="empty-chat-icon">ğŸ’¬</div>
                            <h3>ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”</h3>
                            <p>AIì—ê²Œ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”</p>
                        </div>
                    `;
                    document.getElementById('chat-title').textContent = 'ìƒˆ ëŒ€í™”';
                }
            }

            renderChatRooms();
        }

        // ë©”ì‹œì§€ ê´€ë¦¬
        function loadMessages() {
            if (!currentRoomId) return;

            const saved = localStorage.getItem(`ai_chat_messages_${currentRoomId}`);
            const messages = saved ? JSON.parse(saved) : [];

            renderMessages(messages);
        }

        function saveMessages(messages) {
            if (!currentRoomId) return;
            localStorage.setItem(`ai_chat_messages_${currentRoomId}`, JSON.stringify(messages));
        }

        function getMessages() {
            if (!currentRoomId) return [];
            const saved = localStorage.getItem(`ai_chat_messages_${currentRoomId}`);
            return saved ? JSON.parse(saved) : [];
        }

        function renderMessages(messages) {
            const container = document.getElementById('chat-messages');

            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-chat">
                        <div class="empty-chat-icon">ğŸ’¬</div>
                        <h3>ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”</h3>
                        <p>AIì—ê²Œ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.role}">
                    <div class="message-avatar">${msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
                    <div class="message-content">
                        <div class="message-bubble">${escapeHtml(msg.content)}</div>
                        <div class="message-time">${formatTime(msg.timestamp)}</div>
                    </div>
                </div>
            `).join('');

            container.scrollTop = container.scrollHeight;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();

            if (!content || isGenerating) return;

            // ëŒ€í™”ë°©ì´ ì—†ìœ¼ë©´ ìƒì„±
            if (!currentRoomId) {
                createNewChat();
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            const messages = getMessages();
            const userMessage = {
                role: 'user',
                content: content,
                timestamp: new Date().toISOString()
            };
            messages.push(userMessage);
            saveMessages(messages);
            renderMessages(messages);

            // ì…ë ¥ ì´ˆê¸°í™”
            input.value = '';
            input.style.height = 'auto';

            // ëŒ€í™”ë°© ì œëª© ì—…ë°ì´íŠ¸ (ì²« ë©”ì‹œì§€ì¸ ê²½ìš°)
            if (messages.length === 1) {
                updateRoomTitle(content.substring(0, 30) + (content.length > 30 ? '...' : ''));
            }

            // AI ì‘ë‹µ ìƒì„±
            await generateResponse(messages);
        }

        async function generateResponse(messages) {
            isGenerating = true;
            document.getElementById('send-btn').disabled = true;

            const container = document.getElementById('chat-messages');

            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì¶”ê°€
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typing-message';
            typingDiv.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;

            try {
                // Ollama API í˜¸ì¶œ (ìŠ¤íŠ¸ë¦¬ë°)
                const response = await fetch(`${OLLAMA_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: [
                            { role: 'system', content: settings.systemPrompt },
                            ...messages.map(m => ({ role: m.role, content: m.content }))
                        ],
                        stream: true,
                        options: {
                            temperature: settings.temperature
                        }
                    })
                });

                if (!response.ok) throw new Error('API request failed');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantContent = '';

                // íƒ€ì´í•‘ ë©”ì‹œì§€ë¥¼ ì‹¤ì œ ì‘ë‹µìœ¼ë¡œ ë³€ê²½
                typingDiv.querySelector('.message-bubble').innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim());

                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line);
                            if (data.message && data.message.content) {
                                assistantContent += data.message.content;
                                typingDiv.querySelector('.message-bubble').textContent = assistantContent;
                                container.scrollTop = container.scrollHeight;
                            }
                        } catch (e) {
                            // JSON íŒŒì‹± ì˜¤ë¥˜ ë¬´ì‹œ
                        }
                    }
                }

                // ìµœì¢… ë©”ì‹œì§€ ì €ì¥
                if (assistantContent) {
                    const assistantMessage = {
                        role: 'assistant',
                        content: assistantContent,
                        timestamp: new Date().toISOString()
                    };
                    messages.push(assistantMessage);
                    saveMessages(messages);

                    // íƒ€ì´í•‘ ë©”ì‹œì§€ì— ì‹œê°„ ì¶”ê°€
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'message-time';
                    timeDiv.textContent = formatTime(assistantMessage.timestamp);
                    typingDiv.querySelector('.message-content').appendChild(timeDiv);

                    // ëŒ€í™”ë°© ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
                    updateRoomTimestamp();
                }

            } catch (error) {
                console.error('Generation error:', error);
                typingDiv.querySelector('.message-bubble').innerHTML =
                    '<span style="color: var(--accent-red);">ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. Ollamaê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</span>';
            }

            isGenerating = false;
            document.getElementById('send-btn').disabled = false;
            typingDiv.id = '';
        }

        function updateRoomTitle(title) {
            const room = chatRooms.find(r => r.id === currentRoomId);
            if (room) {
                room.title = title;
                saveChatRooms();
                renderChatRooms();
                document.getElementById('chat-title').textContent = title;
            }
        }

        function updateRoomTimestamp() {
            const room = chatRooms.find(r => r.id === currentRoomId);
            if (room) {
                room.updatedAt = new Date().toISOString();
                // ìµœê·¼ ëŒ€í™”ë¥¼ ë§¨ ìœ„ë¡œ
                chatRooms.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                saveChatRooms();
                renderChatRooms();
            }
        }

        // ì„¤ì • ê´€ë¦¬
        function loadSettings() {
            const saved = localStorage.getItem('ai_chat_settings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }
            currentModel = settings.defaultModel;
        }

        function saveSettings() {
            settings.defaultModel = document.getElementById('setting-model').value;
            settings.temperature = parseFloat(document.getElementById('setting-temperature').value);
            settings.systemPrompt = document.getElementById('setting-system-prompt').value;

            localStorage.setItem('ai_chat_settings', JSON.stringify(settings));
            currentModel = settings.defaultModel;
            document.getElementById('model-selector').value = currentModel;

            closeSettingsModal();
        }

        function openSettingsModal() {
            document.getElementById('setting-model').value = settings.defaultModel;
            document.getElementById('setting-temperature').value = settings.temperature;
            document.getElementById('temp-value').textContent = settings.temperature;
            document.getElementById('setting-system-prompt').value = settings.systemPrompt;
            document.getElementById('settings-modal').classList.add('show');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
        }

        // Temperature ìŠ¬ë¼ì´ë” ê°’ í‘œì‹œ
        document.getElementById('setting-temperature').addEventListener('input', (e) => {
            document.getElementById('temp-value').textContent = e.target.value;
        });

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        function toggleSidebar() {
            document.getElementById('chat-sidebar').classList.toggle('show');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            if (diff < 86400000) { // 24ì‹œê°„ ì´ë‚´
                return formatTime(dateString);
            } else if (diff < 604800000) { // 7ì¼ ì´ë‚´
                const days = Math.floor(diff / 86400000);
                return `${days}ì¼ ì „`;
            } else {
                return `${date.getMonth() + 1}/${date.getDate()}`;
            }
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target.id === 'settings-modal') {
                closeSettingsModal();
            }
        });
    </script>
</body>
</html>
